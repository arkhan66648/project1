<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Dynamic Title & Description -->
    <title>{{META_TITLE}}</title>
    <meta name='description' content='{{META_DESC}}'>
    

    
    <!-- Robots -->
    <meta name="robots" content="index, follow"> 
    
    <link rel="icon" href="{{FAVICON}}">
    {{LOGO_PRELOAD}}

    <!-- CSS Variables & Styles -->
    <style>
        :root {
            /* BASE THEME */
            --brand-primary: {{THEME_BRAND_PRIMARY}};
            --bg-body: {{THEME_BG_BODY}};
            --bg-panel: {{THEME_BG_PANEL}};
            --text-main: {{THEME_TEXT_MAIN}};
            --text-muted: {{THEME_TEXT_MUTED}};
            --border: {{THEME_BORDER_COLOR}};
            --font-family-base: {{THEME_FONT_FAMILY_BASE}};
            --font-family-headings: {{THEME_FONT_FAMILY_HEADINGS}};
            --base-font-size: {{THEME_BASE_FONT_SIZE}}; 
            --container-max-width: {{THEME_CONTAINER_MAX_WIDTH}};
            --border-radius-base: {{THEME_BORDER_RADIUS_BASE}}; 

            /* HEADER */
            --header-bg: {{THEME_HEADER_BG}};
            --header-text-color: {{THEME_HEADER_TEXT_COLOR}};
            --header-link-hover-color: {{THEME_HEADER_LINK_HOVER_COLOR}};
            --header-border-bottom: {{THEME_HEADER_BORDER_BOTTOM}};
            --logo-text-p1-color: {{THEME_LOGO_P1_COLOR}};
            --logo-text-p2-color: {{THEME_LOGO_P2_COLOR}};
            --logo-image-size: {{THEME_LOGO_IMAGE_SIZE}};

            /* FOOTER & SOCIALS */
            --footer-bg-start: {{THEME_FOOTER_BG_START}};
            --footer-bg-end: {{THEME_FOOTER_BG_END}};
            --footer-text-align: {{THEME_FOOTER_TEXT_ALIGN_DESKTOP}};
            
            /* WATCH SPECIFIC */
            --btn-watch-bg: {{THEME_MATCH_ROW_BTN_WATCH_BG}};
            --btn-watch-text: {{THEME_MATCH_ROW_BTN_WATCH_TEXT}};
            --status-green: {{THEME_STATUS_GREEN}};
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: var(--font-family-base); background: var(--bg-body); color: var(--text-main); font-size: var(--base-font-size); overflow-x: hidden; padding-bottom: 80px; }
        a { text-decoration: none; color: inherit; transition: 0.2s; }
        button { cursor: pointer; border: none; font-family: inherit; }
        
        /* HEADER */
        header { background: var(--header-bg); backdrop-filter: blur(10px); border-bottom: var(--header-border-bottom); height: 60px; width: 100%; position: fixed; top: 0; z-index: 100; }
        .header-container { max-width: var(--header-max-width, 1100px); margin: 0 auto; height: 100%; padding: 0 15px; display: flex; align-items: center; justify-content: space-between; }
        
        .logo-link { display: flex; align-items: center; gap: 10px; }
        .logo-img { height: var(--logo-image-size); width: var(--logo-image-size); border-radius: var(--border-radius-base); object-fit: cover; }
        .logo-text { font-size: 1.4rem; font-weight: 900; font-style: italic; letter-spacing: -1px; text-transform: uppercase; }
        .logo-text span { color: var(--logo-text-p2-color); } .logo-text { color: var(--logo-text-p1-color); }
        
        .nav-links { display: flex; gap: 20px; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; color: var(--header-text-color); }
        .nav-links a:hover { color: var(--header-link-hover-color); }
        .hamburger { display: none; font-size: 1.4rem; color: var(--header-text-color); background: none; }
        @media (max-width: 900px) { .nav-links { display: none; } .hamburger { display: block; } }

        /* MAIN LAYOUT */
        .watch-wrapper { padding-top: 90px; min-height: 80vh; max-width: 1200px; margin: 0 auto; padding-left: 15px; padding-right: 15px; }
        
        /* EMPTY STATE */
        .empty-state { text-align: center; padding: 100px 20px; display: none; }
        .btn-home { background: var(--brand-primary); color: #fff; padding: 10px 20px; border-radius: var(--border-radius-base); font-weight: 700; margin-top: 20px; display: inline-block; }

        /* --- INFO VIEW (SEO) --- */
        #info-view { display: none; max-width: 800px; margin: 0 auto; }
        .match-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--border-radius-base); padding: 30px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        .league-badge { display: inline-flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.3); padding: 5px 12px; border-radius: 20px; margin-bottom: 20px; border: 1px solid var(--border); }
        .league-badge img { width: 18px; height: 18px; object-fit: contain; }
        .league-badge span { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }

        .teams-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .team-box { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .team-logo { width: 80px; height: 80px; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        .team-name { font-size: 1.2rem; font-weight: 800; line-height: 1.2; }
        
        .vs-badge { font-size: 1.5rem; font-weight: 900; color: var(--text-muted); opacity: 0.5; font-style: italic; }

        .meta-box { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; margin-bottom: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .meta-item { display: flex; flex-direction: column; }
        .meta-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; }
        .meta-val { font-size: 1rem; font-weight: 700; color: var(--text-main); }
        .meta-val.live { color: var(--status-green); animation: pulse 1.5s infinite; }

        .btn-main { background: var(--btn-watch-bg); color: var(--btn-watch-text); font-size: 1.1rem; padding: 16px; border-radius: var(--border-radius-base); font-weight: 800; width: 100%; text-transform: uppercase; transition: 0.2s; display: block; border: 1px solid transparent; }
        .btn-main:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-main.disabled { background: transparent; border-color: var(--border); color: var(--text-muted); cursor: default; }
        .btn-main.disabled:hover { transform: none; filter: none; }

        /* --- PLAYER VIEW (STREAM) --- */
        #player-view { display: none; }
        .player-container { background: #000; width: 100%; aspect-ratio: 16/9; border-radius: var(--border-radius-base); overflow: hidden; border: 1px solid var(--border); position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        iframe { width: 100%; height: 100%; border: none; }
        
        .server-list { margin-top: 20px; background: var(--bg-panel); padding: 20px; border-radius: var(--border-radius-base); border: 1px solid var(--border); }
        .server-head { font-size: 0.9rem; font-weight: 700; color: var(--text-muted); margin-bottom: 15px; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
        .server-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .srv-btn { background: rgba(255,255,255,0.05); color: var(--text-main); padding: 8px 16px; border-radius: 4px; font-size: 0.85rem; font-weight: 600; border: 1px solid var(--border); transition: 0.2s; }
        .srv-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--text-muted); }
        .srv-btn.active { background: var(--brand-primary); color: white; border-color: var(--brand-primary); }

        /* FOOTER */
        footer { margin-top: 60px; padding: 40px 20px; border-top: 1px solid var(--border); background: linear-gradient(180deg, var(--footer-bg-start) 0%, var(--footer-bg-end) 100%); text-align: center; }
        .copyright { color: var(--text-muted); font-size: 0.8rem; }

        /* MOBILE */
        @media (max-width: 600px) {
            .teams-area { flex-direction: column; gap: 20px; }
            .vs-badge { transform: rotate(90deg); margin: 10px 0; }
            .team-logo { width: 60px; height: 60px; }
            .team-name { font-size: 1rem; }
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <header class="{{HEADER_CLASSES}}">
        <div class="header-container">
            <a href="/" class="logo-link">{{LOGO_HTML}}</a>
            <nav class="nav-links">{{HEADER_MENU}}</nav>
            <button class="hamburger" onclick="document.getElementById('mobileMenu').classList.toggle('active')">☰</button>
        </div>
    </header>
    <div class="mobile-menu" id="mobileMenu" style="display:none; position:fixed; top:60px; left:0; width:100%; background:var(--bg-panel); flex-direction:column; padding:20px; border-bottom:1px solid var(--border);">{{HEADER_MENU}}</div>

    <div class="watch-wrapper">
        
        <!-- 1. EMPTY STATE -->
        <div id="empty-view" class="empty-state">
            <h2>Match not found</h2>
            <p style="color:var(--text-muted)">The match ID is invalid or the event has ended.</p>
            <a href="/" class="btn-home">Back to Schedule</a>
        </div>

        <!-- 2. INFO VIEW (SEO Optimized / Upcoming) -->
        <div id="info-view">
            <div class="match-card">
                <div class="league-badge" id="info-league-badge">
                    <!-- Injected JS -->
                </div>
                
                <div class="teams-area">
                    <div class="team-box">
                        <img id="t1-logo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="team-logo" alt="Home Team">
                        <div class="team-name" id="t1-name">-</div>
                    </div>
                    <div class="vs-badge">VS</div>
                    <div class="team-box">
                        <img id="t2-logo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="team-logo" alt="Away Team">
                        <div class="team-name" id="t2-name">-</div>
                    </div>
                </div>

                <div class="meta-box">
                    <div class="meta-item">
                        <span class="meta-label">Status</span>
                        <span class="meta-val" id="info-status">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Time</span>
                        <span class="meta-val" id="info-time">-</span>
                    </div>
                </div>

                <div id="info-action-area">
                    <!-- Button injected via JS -->
                </div>
            </div>

            <!-- SEO Article (Injected Dynamically) -->
            <div id="info-article" style="margin-top:40px; color:var(--text-muted); line-height:1.6; font-size:0.9rem;"></div>
        </div>

        <!-- 3. PLAYER VIEW (Live Stream / NoIndex) -->
        <div id="player-view">
            <div class="player-container">
                <iframe id="stream-frame" allow="autoplay; fullscreen; encrypted-media" allowfullscreen></iframe>
            </div>
            
            <div class="server-list">
                <div class="server-head">
                    <svg style="width:16px;height:16px;fill:currentColor" viewBox="0 0 24 24"><path d="M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/></svg>
                    Switch Server / Channel
                </div>
                <div class="server-grid" id="server-grid">
                    <!-- Buttons injected via JS -->
                </div>
            </div>
            
            <div style="margin-top:20px; text-align:center;">
                <h1 id="live-h1" style="font-size:1.2rem; margin:0; color:var(--text-main);"></h1>
                <p style="color:var(--text-muted); font-size:0.85rem; margin-top:5px;">Disclaimer: We do not host any content. All streams are embedded from external sites.</p>
            </div>
        </div>

    </div>

    <footer>
        <div class="copyright">{{FOOTER_COPYRIGHT}}</div>
    </footer>

<script>
    // ==========================================
    // 1. CONFIGURATION
    // ==========================================
    const API_URL = "{{API_URL}}";
    const TARGET_COUNTRY = "{{TARGET_COUNTRY}}";
    const SITE_NAME = "{{SITE_NAME}}";
    const SITE_DOMAIN = "https://{{DOMAIN}}";
    
    // Parameters from Admin Panel
    const PARAM_LIVE = "{{PARAM_LIVE}}"; 
    const PARAM_INFO = "{{PARAM_INFO}}"; 
    
    const TEAM_TO_LEAGUE = {{JS_LEAGUE_MAP}}; 
    const IMAGE_MAP = {{JS_IMAGE_MAP}};
    
    const NAME_FIXES = {
        "icehockey": "Ice Hockey", "fieldhockey": "Field Hockey",
        "americanfootball": "American Football", "basketball": "Basketball",
        "football": "Football", "soccer": "Soccer", "baseball": "Baseball",
        "fighting": "Fighting", "mma": "MMA", "boxing": "Boxing",
        "motorsport": "Motorsport", "golf": "Golf"
    };

    // ==========================================
    // 2. INIT
    // ==========================================
    window.addEventListener('DOMContentLoaded', initWatch);

    async function initWatch() {
        const params = new URLSearchParams(window.location.search);

        const liveSlug = params.get(PARAM_LIVE);
        const infoSlug = params.get(PARAM_INFO);

        const activeSlug = (liveSlug || infoSlug || "").trim().toLowerCase();
        const mode = liveSlug ? "live" : (infoSlug ? "info" : null);

        if (!activeSlug || !mode) {
            showEmpty();
            return;
        }

        try {
            const res = await fetch(`${API_URL}?country=${TARGET_COUNTRY.toLowerCase()}`);
            const data = await res.json();

            const match = data.matches.find(m => {
                return extractHash(m.id) === activeSlug;
            });

            if (!match) {
                console.warn("Match not found:", activeSlug);
                showEmpty();
                return;
            }

            processMatchData(match);

            if (mode === "live") {
                renderPlayerMode(match);
            } else {
                renderInfoMode(match);
            }

        } catch (e) {
            console.error("API Error", e);
            showEmpty();
        }
    }

    // ==========================================
    // 3. CORE HELPERS
    // ==========================================
    function extractHash(id) {
        if (!id) return "";
        const parts = id.toLowerCase().split("-");
        return parts[parts.length - 1];
    }

    function slugify(text) {
        return (text || "").toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
    }

    // ==========================================
    // 4. PROCESSING
    // ==========================================
    function processMatchData(m) {
        const hSlug = slugify(m.home_team);
        const aSlug = slugify(m.away_team);
        
        let resolvedLeague = m.league || m.sport;

        if (TEAM_TO_LEAGUE) {
            if (TEAM_TO_LEAGUE[hSlug] && TEAM_TO_LEAGUE[hSlug] === TEAM_TO_LEAGUE[aSlug]) {
                resolvedLeague = TEAM_TO_LEAGUE[hSlug];
            }
        }

        let cleanLeague = resolvedLeague.trim();
        const lKey = cleanLeague.toLowerCase().replace(/\s/g, '');
        if (NAME_FIXES[lKey]) cleanLeague = NAME_FIXES[lKey];

        m.finalLeague = cleanLeague;
        m.cleanHome = getCleanTeamName(m.home_team, hSlug, cleanLeague);
        m.cleanAway = getCleanTeamName(m.away_team, aSlug, cleanLeague);
        m.fmtTime = formatMatchTime(m.startTimeUnix || new Date(m.timestamp).getTime());
        m.hashId = extractHash(m.id);
    }

    function getCleanTeamName(rawName, slug, leagueName) {
        if (!rawName || rawName === "TBA") return "TBA";
        if (TEAM_TO_LEAGUE && TEAM_TO_LEAGUE[slug]) {
            return slug.split("-").map(w => w[0].toUpperCase() + w.slice(1)).join(" ");
        }
        return rawName.replace(/^(NHL|NBA|NFL|MLB|UFC):\s*/i, "").trim();
    }

    // ==========================================
    // 5. RENDERERS
    // ==========================================
    function renderPlayerMode(m) {
        document.getElementById("player-view").style.display = "block";
        document.querySelector('meta[name="robots"]').content = "noindex, nofollow";

        document.title = `Live: ${m.cleanHome} vs ${m.cleanAway}`;
        document.getElementById("live-h1").innerText =
            `${m.cleanHome} vs ${m.cleanAway} Live Stream`;

        const grid = document.getElementById("server-grid");

        if (m.stream_channels && m.stream_channels.length) {
            loadChannel(m.stream_channels[0].url);
            m.stream_channels.forEach((ch, i) => {
                const btn = document.createElement("button");
                btn.className = "srv-btn" + (i === 0 ? " active" : "");
                btn.innerText = ch.name || `Server ${i + 1}`;
                btn.onclick = () => {
                    loadChannel(ch.url);
                    document.querySelectorAll(".srv-btn").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                };
                grid.appendChild(btn);
            });
        } else {
            document.getElementById("stream-frame").style.display = "none";
            grid.innerHTML = `<div style="color:var(--text-muted)">No streams available yet.</div>`;
        }
    }

    function renderInfoMode(m) {
        document.getElementById("info-view").style.display = "block";
        document.querySelector('meta[name="robots"]').content = "index, follow";

        const title = `Watch ${m.cleanHome} vs ${m.cleanAway} Live Stream | ${m.finalLeague}`;
        const desc = `Watch ${m.cleanHome} vs ${m.cleanAway} live stream online.`;

        document.title = title;
        setMeta("description", desc);

        safeText("t1-name", m.cleanHome);
        safeText("t2-name", m.cleanAway);
        safeSrc("t1-logo", getLogoUrl(m.cleanHome, m.home_team_image));
        safeSrc("t2-logo", getLogoUrl(m.cleanAway, m.away_team_image));
        safeText("info-time", m.fmtTime);

        document.getElementById("info-league-badge").innerHTML =
            `<img src="${getLeagueLogo(m.finalLeague, m.league_image)}"><span>${m.finalLeague}</span>`;

        const status = document.getElementById("info-status");
        status.innerText = m.is_live ? "LIVE NOW" : (m.status_text || "Upcoming");
        status.className = "meta-val" + (m.is_live ? " live" : "");

        const action = document.getElementById("info-action-area");
        action.innerHTML = m.is_live
            ? `<a href="${SITE_DOMAIN}/watch/?${PARAM_LIVE}=${m.hashId}" class="btn-main">▶ Watch Live Stream</a>`
            : `<button class="btn-main disabled">⏳ Stream Starts Soon</button>`;

        injectSchema(m);
    }

    // ==========================================
    // 6. UTILITIES
    // ==========================================
    function loadChannel(url) {
        const frame = document.getElementById("stream-frame");
        frame.src = url;
        frame.style.display = "block";
    }

    function safeText(id, text) {
        const el = document.getElementById(id);
        if (el) el.innerText = text || "-";
    }

    function safeSrc(id, src) {
        const el = document.getElementById(id);
        if (el) el.src = src;
    }

    function setMeta(name, content) {
        const el = document.querySelector(`meta[name="${name}"]`);
        if (el) el.content = content;
    }

    function formatMatchTime(unix) {
        if (!unix) return "-";
        const tz = TARGET_COUNTRY === "UK" ? "Europe/London" : "America/New_York";
        return new Intl.DateTimeFormat("en-US", {
            month: "short", day: "numeric", hour: "numeric", minute: "2-digit",
            hour12: true, timeZone: tz
        }).format(new Date(unix));
    }

    function showEmpty() {
        document.getElementById("empty-view").style.display = "block";
    }
</script>

</body>
</html>
