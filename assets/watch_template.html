<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Watch Match</title>
<meta name="description" content="Watch live sports online">
<meta name="robots" content="index, follow">

<link rel="icon" href="{{FAVICON}}">

<style>
body {
    margin:0;
    font-family:Arial, sans-serif;
    background:#0f1115;
    color:#fff;
}
.watch-wrapper {
    max-width:1100px;
    margin:100px auto;
    padding:0 15px;
}
.hidden { display:none !important; }

/* INFO VIEW */
.match-card {
    background:#1a1d24;
    border-radius:10px;
    padding:30px;
    text-align:center;
}
.league-badge {
    display:inline-flex;
    gap:10px;
    align-items:center;
    margin-bottom:20px;
    opacity:.8;
}
.league-badge img { height:20px; }
.teams {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin:30px 0;
}
.team {
    flex:1;
}
.team img {
    height:80px;
    margin-bottom:10px;
}
.vs {
    font-size:28px;
    opacity:.5;
}
.meta {
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:20px;
    margin:20px 0;
}
.meta span { opacity:.7; }
.btn-main {
    display:block;
    margin-top:20px;
    padding:15px;
    background:#ff0055;
    border-radius:6px;
    font-weight:700;
    text-decoration:none;
    color:#fff;
}
.btn-disabled {
    background:#333;
    cursor:default;
}

/* PLAYER */
.player {
    background:black;
    aspect-ratio:16/9;
}
.player iframe {
    width:100%;
    height:100%;
}
.servers {
    margin-top:20px;
}
.servers button {
    margin:5px;
    padding:8px 15px;
    background:#222;
    color:#fff;
    border:none;
    border-radius:4px;
    cursor:pointer;
}
.servers button.active {
    background:#ff0055;
}
</style>
</head>

<body>

<div class="watch-wrapper">

<!-- EMPTY -->
<div id="empty-view" class="hidden">
    <h2>Match not found</h2>
</div>

<!-- INFO -->
<div id="info-view" class="hidden">
    <div class="match-card">
        <div class="league-badge">
            <img id="league-logo">
            <strong id="league-name"></strong>
        </div>

        <div class="teams">
            <div class="team">
                <img id="home-logo">
                <div id="home-name"></div>
            </div>
            <div class="vs">VS</div>
            <div class="team">
                <img id="away-logo">
                <div id="away-name"></div>
            </div>
        </div>

        <div class="meta">
            <div>
                <span>Status</span>
                <div id="match-status"></div>
            </div>
            <div>
                <span>Time</span>
                <div id="match-time"></div>
            </div>
        </div>

        <div id="info-action"></div>
    </div>

    <div id="info-article" style="margin-top:40px;opacity:.7"></div>
</div>

<!-- LIVE -->
<div id="live-view" class="hidden">
    <div class="player">
        <iframe id="player-frame" allowfullscreen></iframe>
    </div>

    <div class="servers" id="server-list"></div>
    <h1 id="live-title" style="margin-top:20px"></h1>
</div>

</div>

<script>
const API_URL = "{{API_URL}}";
const PARAM_INFO = "{{PARAM_INFO}}" || "info";
const PARAM_LIVE = "{{PARAM_LIVE}}" || "live";

/* INIT */
(async function () {
    const params = new URLSearchParams(location.search);
    const hash = params.get(PARAM_INFO) || params.get(PARAM_LIVE);
    const mode = params.has(PARAM_LIVE) ? "live" : "info";

    if (!hash) return showEmpty();

    try {
        const res = await fetch(API_URL);
        const data = await res.json();
        
        // Debug: Check what the API actually returned
        console.log("API Data:", data);

        // Find match (adjust logic if your API structure differs)
        const match = data.matches.find(m => extractHash(m.id) === hash);

        if (!match) {
            console.error("Match not found for hash:", hash);
            return showEmpty();
        }

        render(match, mode);
    } catch (e) {
        console.error("Error loading data:", e);
    }
})();

/* CORE */
function render(m, mode) {
    normalize(m);
    
    // Debug: Check how data looks after normalization
    console.log("Normalized Match Data:", m);

    if (mode === "info") renderInfo(m);
    else renderLive(m);
}

/* INFO */
function renderInfo(m) {
    document.getElementById("info-view").classList.remove("hidden");
    document.title = `Watch ${m.home} vs ${m.away}`;

    set("league-name", m.league);
    set("home-name", m.home);
    set("away-name", m.away);
    set("match-time", m.time);
    set("match-status", m.is_live ? "LIVE NOW" : "Upcoming");

    // Handle images safely
    if(m.home_logo) document.getElementById("home-logo").src = m.home_logo;
    if(m.away_logo) document.getElementById("away-logo").src = m.away_logo;
    if(m.league_logo) document.getElementById("league-logo").src = m.league_logo;

    const act = document.getElementById("info-action");
    if (m.is_live) {
        act.innerHTML = `<a class="btn-main" href="?${PARAM_LIVE}=${extractHash(m.id)}">â–¶ Watch Live</a>`;
    } else {
        act.innerHTML = `<div class="btn-main btn-disabled">Starts Soon</div>`;
    }

    document.getElementById("info-article").innerHTML =
        `<h1>${m.home} vs ${m.away}</h1>
         <p>Watch ${m.home} vs ${m.away} live online in ${m.league}.</p>`;
}

/* LIVE */
function renderLive(m) {
    document.getElementById("live-view").classList.remove("hidden");

    document.title = `${m.home} vs ${m.away} Live`;
    document.getElementById("live-title").textContent = `${m.home} vs ${m.away} Live Stream`;

    // Check if streams exist
    if (!m.streams || !m.streams.length) {
        console.warn("No streams found for this match.");
        document.getElementById("server-list").innerHTML = "<p>No streams available yet.</p>";
        return;
    }

    // Load first stream
    loadStream(m.streams[0].url);

    const list = document.getElementById("server-list");
    list.innerHTML = ""; // Clear previous buttons
    
    m.streams.forEach((s,i)=>{
        const b = document.createElement("button");
        b.textContent = s.name || `Server ${i+1}`;
        if(i===0) b.classList.add("active");
        b.onclick = ()=>{
            loadStream(s.url);
            document.querySelectorAll(".servers button").forEach(x=>x.classList.remove("active"));
            b.classList.add("active");
        };
        list.appendChild(b);
    });
}

/* HELPERS */
function extractHash(id) {
    // Ensure id is a string before splitting
    return String(id).split("-").pop();
}

function normalize(m) {
    // 1. SAFE ASSIGNMENT (Check multiple possible keys from API)
    m.home = m.home_team || m.home || "Home Team";
    m.away = m.away_team || m.away || "Away Team";
    m.league = m.league || m.competition_name || "Match";
    
    // 2. FIX TIMESTAMP (Seconds vs Milliseconds)
    let ts = m.timestamp || m.startTimeUnix || m.start_time;
    if (ts) {
        // If timestamp is in seconds (e.g., 1700000000), convert to ms
        if (typeof ts === 'number' && ts < 10000000000) {
            ts = ts * 1000;
        }
        m.time = new Date(ts).toLocaleString();
    } else {
        m.time = "TBD";
    }

    // 3. FIX STREAMS (Map to standard array)
    m.streams = m.stream_channels || m.streams || m.sources || [];

    // 4. FIX IMAGES (Correct the typo 'sofascrore' -> 'sofascore')
    // We check deeper keys safely using optional chaining (?.)
    m.home_logo = m.home_team_image?.sofascore || m.home_logo || m.home_team_logo || "";
    m.away_logo = m.away_team_image?.sofascore || m.away_logo || m.away_team_logo || "";
    m.league_logo = m.league_image?.sofascore || m.league_logo || "";
    
    // 5. STATUS
    // If API doesn't have is_live, infer it from streams existence or status string
    if (typeof m.is_live === 'undefined') {
        m.is_live = (m.streams.length > 0); 
    }
}

function set(id,val){ 
    const el = document.getElementById(id);
    if(el) el.textContent = val; 
}
function loadStream(u){ 
    document.getElementById("player-frame").src = u; 
}
function showEmpty(){ 
    document.getElementById("empty-view").classList.remove("hidden"); 
}
</script>
</html>
